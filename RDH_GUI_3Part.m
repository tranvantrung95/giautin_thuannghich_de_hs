function RDH_GUI_3Part()
% RDH_GUI_3PART - Giao di·ªán 3 workflow ri√™ng bi·ªát cho RDH
% Workflow 1: Embedding (Gi·∫•u tin)
% Workflow 2: Extraction (Tr√≠ch xu·∫•t)  
% Workflow 3: Recovery (Kh√¥i ph·ª•c)

% T·∫°o figure ch√≠nh
fig = figure('Visible', 'off', ...
             'Position', [100, 100, 1400, 900], ...
             'Name', 'RDH System - 3 Workflows', ...
             'NumberTitle', 'off', ...
             'MenuBar', 'none', ...
             'ToolBar', 'none', ...
             'Resize', 'off', ...
             'Color', [0.97 0.97 0.98], ...
             'CloseRequestFcn', @closeGUI);

% Kh·ªüi t·∫°o handles
handles = struct();
handles.current_tab = 1;
handles.embed_data = struct();
handles.extract_data = struct();
handles.recovery_data = struct();

% T·∫°o Tab Panel ch√≠nh
tab_panel = uipanel('Parent', fig, ...
                   'Title', '', ...
                   'Units', 'normalized', ...
                   'Position', [0.01 0.01 0.98 0.98], ...
                   'BorderType', 'none');

% Tab buttons
tab_height = 0.06;
tab_width = 0.33;

handles.tab1_btn = uicontrol('Parent', tab_panel, ...
                            'Style', 'pushbutton', ...
                            'String', '1. GI·∫§U TIN (EMBEDDING)', ...
                            'Units', 'normalized', ...
                            'Position', [0, 1-tab_height, tab_width, tab_height], ...
                            'FontSize', 12, ...
                            'FontWeight', 'bold', ...
                            'BackgroundColor', [0.2 0.6 0.8], ...
                            'ForegroundColor', 'white', ...
                            'Callback', @(~,~) switchTab(1));

handles.tab2_btn = uicontrol('Parent', tab_panel, ...
                            'Style', 'pushbutton', ...
                            'String', '2. TR√çCH XU·∫§T (EXTRACTION)', ...
                            'Units', 'normalized', ...
                            'Position', [tab_width, 1-tab_height, tab_width, tab_height], ...
                            'FontSize', 12, ...
                            'FontWeight', 'bold', ...
                            'BackgroundColor', [0.6 0.6 0.6], ...
                            'ForegroundColor', 'white', ...
                            'Callback', @(~,~) switchTab(2));

handles.tab3_btn = uicontrol('Parent', tab_panel, ...
                            'Style', 'pushbutton', ...
                            'String', '3. KH√îI PH·ª§C (RECOVERY)', ...
                            'Units', 'normalized', ...
                            'Position', [2*tab_width, 1-tab_height, tab_width, tab_height], ...
                            'FontSize', 12, ...
                            'FontWeight', 'bold', ...
                            'BackgroundColor', [0.6 0.6 0.6], ...
                            'ForegroundColor', 'white', ...
                            'Callback', @(~,~) switchTab(3));

% Content area
content_area = [0, 0, 1, 1-tab_height];

%% TAB 1: EMBEDDING
handles.tab1_panel = uipanel('Parent', tab_panel, ...
                            'Title', '', ...
                            'Units', 'normalized', ...
                            'Position', content_area, ...
                            'BorderType', 'none', ...
                            'Visible', 'on');

% Tab 1 Content
handles = createTab1Content(handles.tab1_panel, handles);

%% TAB 2: EXTRACTION  
handles.tab2_panel = uipanel('Parent', tab_panel, ...
                            'Title', '', ...
                            'Units', 'normalized', ...
                            'Position', content_area, ...
                            'BorderType', 'none', ...
                            'Visible', 'off');

% Tab 2 Content
handles = createTab2Content(handles.tab2_panel, handles);

%% TAB 3: RECOVERY
handles.tab3_panel = uipanel('Parent', tab_panel, ...
                            'Title', '', ...
                            'Units', 'normalized', ...
                            'Position', content_area, ...
                            'BorderType', 'none', ...
                            'Visible', 'off');

% Tab 3 Content  
handles = createTab3Content(handles.tab3_panel, handles);

% L∆∞u handles
set(fig, 'UserData', handles);

% Hi·ªÉn th·ªã GUI
set(fig, 'Visible', 'on');

%% HELPER FUNCTIONS

    function switchTab(tab_num)
        handles = get(gcf, 'UserData');
        
        % Hide all tabs
        set(handles.tab1_panel, 'Visible', 'off');
        set(handles.tab2_panel, 'Visible', 'off');
        set(handles.tab3_panel, 'Visible', 'off');
        
        % Reset button colors
        set(handles.tab1_btn, 'BackgroundColor', [0.6 0.6 0.6]);
        set(handles.tab2_btn, 'BackgroundColor', [0.6 0.6 0.6]);
        set(handles.tab3_btn, 'BackgroundColor', [0.6 0.6 0.6]);
        
        % Show selected tab and highlight button
        switch tab_num
            case 1
                set(handles.tab1_panel, 'Visible', 'on');
                set(handles.tab1_btn, 'BackgroundColor', [0.2 0.6 0.8]);
            case 2
                set(handles.tab2_panel, 'Visible', 'on');
                set(handles.tab2_btn, 'BackgroundColor', [0.2 0.6 0.8]);
            case 3
                set(handles.tab3_panel, 'Visible', 'on');
                set(handles.tab3_btn, 'BackgroundColor', [0.2 0.6 0.8]);
        end
        
        handles.current_tab = tab_num;
        set(gcf, 'UserData', handles);
    end

    function updateMatrixTable(table_handle, img, focus_rc)
        if isempty(table_handle) || ~ishandle(table_handle)
            return;
        end
        if isempty(img)
            set(table_handle, 'Data', []);
            set(table_handle, 'RowName', {});
            set(table_handle, 'ColumnName', {});
            return;
        end

        if nargin < 3 || isempty(focus_rc)
            focus_rc = [1, 1];
        end

        gray_img = getLumaChannel(img);
        gray_img = double(gray_img);
        r = min(10, size(gray_img, 1));
        c = min(10, size(gray_img, 2));

        % C·∫Øt 10x10 t·ª´ v√πng focus (n·∫øu focus g·∫ßn bi√™n th√¨ d·ªãch v·ªÅ trong ·∫£nh)
        start_r = max(1, min(focus_rc(1), size(gray_img,1) - r + 1));
        start_c = max(1, min(focus_rc(2), size(gray_img,2) - c + 1));
        preview = gray_img(start_r:start_r+r-1, start_c:start_c+c-1);

        set(table_handle, 'Data', round(preview));
        set(table_handle, 'RowName', arrayfun(@(x) num2str(start_r + x - 1), 1:r, 'UniformOutput', false));
        set(table_handle, 'ColumnName', arrayfun(@(x) num2str(start_c + x - 1), 1:c, 'UniformOutput', false));
    end

    function gray = getLumaChannel(img)
        if ndims(img) == 3
            ycbcr_img = rgb2ycbcr(img);
            gray = ycbcr_img(:,:,1);
        else
            gray = img;
        end
    end

    function updateChangeText(handles, value)
        if isfield(handles, 'embed_change_text') && isgraphics(handles.embed_change_text)
            set(handles.embed_change_text, 'String', sprintf('Pixel thay ƒë·ªïi: %s', value));
        end
    end

    function handles = createTab1Content(parent, handles)
        % TAB 1: EMBEDDING
        
        % Input section
        input_panel = uipanel('Parent', parent, ...
                             'Title', 'Input (ƒê·∫ßu v√†o)', ...
                             'FontSize', 12, ...
                             'FontWeight', 'bold', ...
                             'Units', 'normalized', ...
                             'Position', [0.02 0.7 0.46 0.28]);
        
        % Load original image
        uicontrol('Parent', input_panel, ...
                  'Style', 'pushbutton', ...
                  'String', 'N·∫°p ·∫£nh g·ªëc', ...
                  'Units', 'normalized', ...
                  'Position', [0.05 0.75 0.4 0.15], ...
                  'FontSize', 10, ...
                  'Callback', @embed_loadOriginalImage);
        
        uicontrol('Parent', input_panel, ...
                  'Style', 'pushbutton', ...
                  'String', '·∫¢nh Demo', ...
                  'Units', 'normalized', ...
                  'Position', [0.55 0.75 0.4 0.15], ...
                  'FontSize', 10, ...
                  'Callback', @embed_loadDemoImage);
        
        % Secret data input
        uicontrol('Parent', input_panel, ...
                  'Style', 'text', ...
                  'String', 'D·ªØ li·ªáu b√≠ m·∫≠t:', ...
                  'Units', 'normalized', ...
                  'Position', [0.05 0.55 0.3 0.1], ...
                  'HorizontalAlignment', 'left', ...
                  'FontSize', 10);
        
        handles.embed_secret_edit = uicontrol('Parent', input_panel, ...
                                             'Style', 'edit', ...
                                             'String', 'ƒê√¢y l√† d·ªØ li·ªáu b√≠ m·∫≠t!', ...
                                             'Units', 'normalized', ...
                                             'Position', [0.05 0.4 0.9 0.1], ...
                                             'FontSize', 10, ...
                                             'HorizontalAlignment', 'left');
        
        % Algorithm selection
        uicontrol('Parent', input_panel, ...
                  'Style', 'text', ...
                  'String', 'Thu·∫≠t to√°n:', ...
                  'Units', 'normalized', ...
                  'Position', [0.05 0.25 0.3 0.1], ...
                  'HorizontalAlignment', 'left', ...
                  'FontSize', 10);
        
        handles.embed_algorithm_popup = uicontrol('Parent', input_panel, ...
                                                 'Style', 'popup', ...
                                                 'String', {'Histogram Shifting (HS)', 'Difference Expansion (DE)'}, ...
                                                 'Units', 'normalized', ...
                                                 'Position', [0.4 0.25 0.55 0.1], ...
                                                 'FontSize', 10, ...
                                                 'Value', 1);
        
        % Action buttons
        uicontrol('Parent', input_panel, ...
                  'Style', 'pushbutton', ...
                  'String', 'TH·ª∞C HI·ªÜN GI·∫§U TIN', ...
                  'Units', 'normalized', ...
                  'Position', [0.05 0.05 0.9 0.15], ...
                  'FontSize', 12, ...
                  'FontWeight', 'bold', ...
                  'BackgroundColor', [0.2 0.8 0.2], ...
                  'ForegroundColor', 'white', ...
                  'Callback', @embed_performEmbedding);
        
        % Image display section
        image_panel = uipanel('Parent', parent, ...
                             'Title', 'Hi·ªÉn th·ªã ·∫£nh', ...
                             'FontSize', 12, ...
                             'FontWeight', 'bold', ...
                             'Units', 'normalized', ...
                             'Position', [0.5 0.5 0.48 0.48]);
        
        handles.embed_axes_original = axes('Parent', image_panel, ...
                                          'Units', 'normalized', ...
                                          'Position', [0.05 0.55 0.4 0.4]);
        title(handles.embed_axes_original, '·∫¢nh g·ªëc', 'FontSize', 10);
        
        handles.embed_axes_watermarked = axes('Parent', image_panel, ...
                                             'Units', 'normalized', ...
                                             'Position', [0.55 0.55 0.4 0.4]);
        title(handles.embed_axes_watermarked, '·∫¢nh ƒë√£ gi·∫•u tin', 'FontSize', 10);
        
        % Save section
        save_panel = uipanel('Parent', image_panel, ...
                            'Title', 'L∆∞u k·∫øt qu·∫£', ...
                            'Units', 'normalized', ...
                            'Position', [0.05 0.05 0.9 0.45]);
        
        uicontrol('Parent', save_panel, ...
                  'Style', 'pushbutton', ...
                  'String', 'üíæ L∆ØU ·∫¢NH ƒê√É GI·∫§U TIN', ...
                  'Units', 'normalized', ...
                  'Position', [0.05 0.7 0.9 0.25], ...
                  'FontSize', 11, ...
                  'FontWeight', 'bold', ...
                  'BackgroundColor', [0.2 0.6 0.8], ...
                  'ForegroundColor', 'white', ...
                  'Callback', @embed_saveWatermarkedImage);
        
        uicontrol('Parent', save_panel, ...
                  'Style', 'pushbutton', ...
                  'String', 'üìÅ L∆ØU TH√îNG TIN EMBED', ...
                  'Units', 'normalized', ...
                  'Position', [0.05 0.4 0.9 0.25], ...
                  'FontSize', 11, ...
                  'FontWeight', 'bold', ...
                  'BackgroundColor', [0.6 0.4 0.8], ...
                  'ForegroundColor', 'white', ...
                  'Callback', @embed_saveEmbedInfo);
        
        % Info display
        % Matrix preview panel
        matrix_panel = uipanel('Parent', parent, ...
                              'Title', 'Ma tr·∫≠n (preview 10x10)', ...
                              'FontSize', 12, ...
                              'FontWeight', 'bold', ...
                              'Units', 'normalized', ...
                              'Position', [0.02 0.02 0.46 0.48]);

        handles.embed_change_text = uicontrol('Parent', matrix_panel, ...
                                             'Style', 'text', ...
                                             'String', 'Pixel thay ƒë·ªïi: -', ...
                                             'Units', 'normalized', ...
                                             'Position', [0.02 0.9 0.96 0.08], ...
                                             'HorizontalAlignment', 'left', ...
                                             'FontSize', 10, ...
                                             'FontWeight', 'bold');

        uicontrol('Parent', matrix_panel, ...
                  'Style', 'text', ...
                  'String', '·∫¢nh g·ªëc (k√™nh s√°ng/gray)', ...
                  'Units', 'normalized', ...
                  'Position', [0.02 0.8 0.46 0.1], ...
                  'HorizontalAlignment', 'left', ...
                  'FontSize', 10, ...
                  'FontWeight', 'bold');

        handles.embed_matrix_original_table = uitable('Parent', matrix_panel, ...
                                                     'Units', 'normalized', ...
                                                     'Position', [0.02 0.05 0.46 0.8], ...
                                                     'FontSize', 9);

        uicontrol('Parent', matrix_panel, ...
                  'Style', 'text', ...
                  'String', '·∫¢nh sau gi·∫•u tin', ...
                  'Units', 'normalized', ...
                  'Position', [0.52 0.8 0.46 0.1], ...
                  'HorizontalAlignment', 'left', ...
                  'FontSize', 10, ...
                  'FontWeight', 'bold');

        handles.embed_matrix_watermarked_table = uitable('Parent', matrix_panel, ...
                                                        'Units', 'normalized', ...
                                                        'Position', [0.52 0.05 0.46 0.8], ...
                                                        'FontSize', 9);

        handles.embed_info_text = uicontrol('Parent', parent, ...
                                           'Style', 'text', ...
                                           'String', 'üîí TAB 1 - GI·∫§U TIN\n\nüìã H∆Ø·ªöNG D·∫™N:\n1. N·∫°p ·∫£nh g·ªëc (ho·∫∑c d√πng ·∫£nh Demo)\n2. Nh·∫≠p d·ªØ li·ªáu b√≠ m·∫≠t c·∫ßn gi·∫•u\n3. Ch·ªçn thu·∫≠t to√°n (HS khuy·∫øn ngh·ªã)\n4. Nh·∫•n "TH·ª∞C HI·ªÜN GI·∫§U TIN"\n5. ‚ö†Ô∏è QUAN TR·ªåNG: L∆∞u c·∫£ 2 file:\n   ‚Ä¢ "L∆∞u ·∫£nh ƒë√£ gi·∫•u tin" ‚Üí g·ª≠i c√¥ng khai\n   ‚Ä¢ "L∆∞u th√¥ng tin embed" ‚Üí gi·ªØ b√≠ m·∫≠t\n\nüîê LOGIC B·∫¢O M·∫¨T:\n‚Ä¢ ·∫¢nh ƒë√£ gi·∫•u tin: C√≥ th·ªÉ chia s·∫ª tho·∫£i m√°i\n‚Ä¢ File embed: L√† "ch√¨a kh√≥a" - ph·∫£i b·∫£o v·ªá!', ...
                                           'Units', 'normalized', ...
                                           'Position', [0.5 0.02 0.48 0.48], ...
                                           'HorizontalAlignment', 'left', ...
                                           'BackgroundColor', [0.95 0.95 1], ...
                                           'FontSize', 9);
    end

    function handles = createTab2Content(parent, handles)
        % TAB 2: EXTRACTION
        
        % Input section
        input_panel = uipanel('Parent', parent, ...
                             'Title', 'Input (N·∫°p d·ªØ li·ªáu)', ...
                             'FontSize', 12, ...
                             'FontWeight', 'bold', ...
                             'Units', 'normalized', ...
                             'Position', [0.02 0.6 0.46 0.38]);
        
        % Load watermarked image
        uicontrol('Parent', input_panel, ...
                  'Style', 'pushbutton', ...
                  'String', 'üì∑ N·∫†P ·∫¢NH ƒê√É GI·∫§U TIN', ...
                  'Units', 'normalized', ...
                  'Position', [0.05 0.8 0.9 0.15], ...
                  'FontSize', 11, ...
                  'FontWeight', 'bold', ...
                  'BackgroundColor', [0.8 0.4 0.2], ...
                  'ForegroundColor', 'white', ...
                  'Callback', @extract_loadWatermarkedImage);
        
        % Load embed info
        uicontrol('Parent', input_panel, ...
                  'Style', 'pushbutton', ...
                  'String', 'N·∫°p th√¥ng tin embed (.mat)', ...
                  'Units', 'normalized', ...
                  'Position', [0.05 0.6 0.9 0.15], ...
                  'FontSize', 11, ...
                  'FontWeight', 'bold', ...
                  'BackgroundColor', [0.6 0.4 0.8], ...
                  'ForegroundColor', 'white', ...
                  'Callback', @extract_loadEmbedInfo);
        
        % Extract button
        uicontrol('Parent', input_panel, ...
                  'Style', 'pushbutton', ...
                  'String', 'TR√çCH XU·∫§T D·ªÆ LI·ªÜU', ...
                  'Units', 'normalized', ...
                  'Position', [0.05 0.35 0.9 0.2], ...
                  'FontSize', 12, ...
                  'FontWeight', 'bold', ...
                  'BackgroundColor', [0.8 0.2 0.2], ...
                  'ForegroundColor', 'white', ...
                  'Callback', @extract_performExtraction);
        
        % Save extracted data
        uicontrol('Parent', input_panel, ...
                  'Style', 'pushbutton', ...
                  'String', 'L∆∞u d·ªØ li·ªáu tr√≠ch xu·∫•t', ...
                  'Units', 'normalized', ...
                  'Position', [0.05 0.1 0.9 0.15], ...
                  'FontSize', 10, ...
                  'Callback', @extract_saveData);
        
        % Image display
        image_panel = uipanel('Parent', parent, ...
                             'Title', 'Hi·ªÉn th·ªã ·∫£nh', ...
                             'FontSize', 12, ...
                             'FontWeight', 'bold', ...
                             'Units', 'normalized', ...
                             'Position', [0.5 0.6 0.48 0.38]);
        
        handles.extract_axes_watermarked = axes('Parent', image_panel, ...
                                               'Units', 'normalized', ...
                                               'Position', [0.1 0.2 0.8 0.7]);
        title(handles.extract_axes_watermarked, '·∫¢nh ƒë√£ gi·∫•u tin', 'FontSize', 10);
        
        % Result display
        result_panel = uipanel('Parent', parent, ...
                              'Title', 'K·∫øt qu·∫£ tr√≠ch xu·∫•t', ...
                              'FontSize', 12, ...
                              'FontWeight', 'bold', ...
                              'Units', 'normalized', ...
                              'Position', [0.02 0.02 0.96 0.56]);
        
        % Extracted text
        uicontrol('Parent', result_panel, ...
                  'Style', 'text', ...
                  'String', 'D·ªØ li·ªáu tr√≠ch xu·∫•t:', ...
                  'Units', 'normalized', ...
                  'Position', [0.02 0.8 0.2 0.15], ...
                  'HorizontalAlignment', 'left', ...
                  'FontSize', 11, ...
                  'FontWeight', 'bold');
        
        handles.extract_result_text = uicontrol('Parent', result_panel, ...
                                               'Style', 'edit', ...
                                               'String', '', ...
                                               'Units', 'normalized', ...
                                               'Position', [0.02 0.6 0.96 0.15], ...
                                               'FontSize', 12, ...
                                               'BackgroundColor', [0.9 1 0.9], ...
                                               'HorizontalAlignment', 'left', ...
                                               'Max', 2);
        
        % Info display
        handles.extract_info_text = uicontrol('Parent', result_panel, ...
                                             'Style', 'text', ...
                                             'String', 'üîì TAB 2 - TR√çCH XU·∫§T\n\nüìã H∆Ø·ªöNG D·∫™N:\n1. "N·∫°p ·∫£nh ƒë√£ gi·∫•u tin" ‚Üí file .png/.jpg\n2. "N·∫°p th√¥ng tin embed" ‚Üí file .mat (ch√¨a kh√≥a)\n3. Nh·∫•n "TR√çCH XU·∫§T D·ªÆ LI·ªÜU"\n4. Xem d·ªØ li·ªáu b√≠ m·∫≠t ƒë∆∞·ª£c tr√≠ch xu·∫•t\n5. (T√πy ch·ªçn) "L∆∞u d·ªØ li·ªáu tr√≠ch xu·∫•t" ‚Üí file .txt\n\nüîê LOGIC B·∫¢O M·∫¨T:\n‚Ä¢ CH·ªà D√ôNG: ·∫¢nh ƒë√£ gi·∫•u tin + File embed\n‚Ä¢ KH√îNG C·∫¶N: ·∫¢nh g·ªëc (tr√°nh r√≤ r·ªâ b·∫£o m·∫≠t)', ...
                                             'Units', 'normalized', ...
                                             'Position', [0.02 0.02 0.96 0.55], ...
                                             'HorizontalAlignment', 'left', ...
                                             'BackgroundColor', [1 0.95 0.95], ...
                                             'FontSize', 9);
    end

    function handles = createTab3Content(parent, handles)
        % TAB 3: RECOVERY
        
        % Input section
        input_panel = uipanel('Parent', parent, ...
                             'Title', 'Input (N·∫°p d·ªØ li·ªáu)', ...
                             'FontSize', 12, ...
                             'FontWeight', 'bold', ...
                             'Units', 'normalized', ...
                             'Position', [0.02 0.7 0.46 0.28]);
        
        % Load watermarked image
        uicontrol('Parent', input_panel, ...
                  'Style', 'pushbutton', ...
                  'String', 'üì∑ N·∫†P ·∫¢NH ƒê√É GI·∫§U TIN', ...
                  'Units', 'normalized', ...
                  'Position', [0.05 0.75 0.9 0.2], ...
                  'FontSize', 11, ...
                  'FontWeight', 'bold', ...
                  'BackgroundColor', [0.8 0.4 0.2], ...
                  'ForegroundColor', 'white', ...
                  'Callback', @recovery_loadWatermarkedImage);
        
        % Load embed info
        uicontrol('Parent', input_panel, ...
                  'Style', 'pushbutton', ...
                  'String', 'N·∫°p th√¥ng tin embed (.mat)', ...
                  'Units', 'normalized', ...
                  'Position', [0.05 0.5 0.9 0.2], ...
                  'FontSize', 11, ...
                  'FontWeight', 'bold', ...
                  'BackgroundColor', [0.6 0.4 0.8], ...
                  'ForegroundColor', 'white', ...
                  'Callback', @recovery_loadEmbedInfo);
        
        % Recover button
        uicontrol('Parent', input_panel, ...
                  'Style', 'pushbutton', ...
                  'String', 'KH√îI PH·ª§C ·∫¢NH G·ªêC', ...
                  'Units', 'normalized', ...
                  'Position', [0.05 0.05 0.9 0.35], ...
                  'FontSize', 12, ...
                  'FontWeight', 'bold', ...
                  'BackgroundColor', [0.2 0.7 0.2], ...
                  'ForegroundColor', 'white', ...
                  'Callback', @recovery_performRecovery);
        
        % Image display section
        image_panel = uipanel('Parent', parent, ...
                             'Title', 'So s√°nh ·∫£nh', ...
                             'FontSize', 12, ...
                             'FontWeight', 'bold', ...
                             'Units', 'normalized', ...
                             'Position', [0.5 0.4 0.48 0.58]);
        
        handles.recovery_axes_watermarked = axes('Parent', image_panel, ...
                                                'Units', 'normalized', ...
                                                'Position', [0.05 0.55 0.4 0.4]);
        title(handles.recovery_axes_watermarked, '·∫¢nh ƒë√£ gi·∫•u tin', 'FontSize', 9);
        
        handles.recovery_axes_recovered = axes('Parent', image_panel, ...
                                              'Units', 'normalized', ...
                                              'Position', [0.55 0.55 0.4 0.4]);
        title(handles.recovery_axes_recovered, '·∫¢nh ƒë√£ kh√¥i ph·ª•c', 'FontSize', 9);
        
        % Save section
        save_panel = uipanel('Parent', image_panel, ...
                            'Title', 'L∆∞u k·∫øt qu·∫£', ...
                            'Units', 'normalized', ...
                            'Position', [0.05 0.05 0.9 0.45]);
        
        uicontrol('Parent', save_panel, ...
                  'Style', 'pushbutton', ...
                  'String', 'L∆∞u ·∫£nh ƒë√£ kh√¥i ph·ª•c', ...
                  'Units', 'normalized', ...
                  'Position', [0.05 0.6 0.9 0.35], ...
                  'FontSize', 11, ...
                  'FontWeight', 'bold', ...
                  'Callback', @recovery_saveRecoveredImage);
        
        % Comparison info
        handles.recovery_comparison_text = uicontrol('Parent', save_panel, ...
                                                    'Style', 'text', ...
                                                    'String', 'Th√¥ng tin so s√°nh s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y', ...
                                                    'Units', 'normalized', ...
                                                    'Position', [0.05 0.05 0.9 0.5], ...
                                                    'HorizontalAlignment', 'left', ...
                                                    'BackgroundColor', 'white', ...
                                                    'FontSize', 9);
        
        % Info display
        handles.recovery_info_text = uicontrol('Parent', parent, ...
                                              'Style', 'text', ...
                                              'String', '‚ôªÔ∏è TAB 3 - KH√îI PH·ª§C\n\nüìã H∆Ø·ªöNG D·∫™N:\n1. "N·∫°p ·∫£nh ƒë√£ gi·∫•u tin" ‚Üí file .png/.jpg\n2. "N·∫°p th√¥ng tin embed" ‚Üí file .mat (ch√¨a kh√≥a)\n3. Nh·∫•n "KH√îI PH·ª§C ·∫¢NH G·ªêC"\n4. So s√°nh ·∫£nh ƒë√£ gi·∫•u tin vs ·∫£nh kh√¥i ph·ª•c\n5. (T√πy ch·ªçn) "L∆∞u ·∫£nh ƒë√£ kh√¥i ph·ª•c"\n\nüîê LOGIC B·∫¢O M·∫¨T:\n‚Ä¢ CH·ªà D√ôNG: ·∫¢nh ƒë√£ gi·∫•u tin + File embed\n‚Ä¢ KH√îNG C·∫¶N: ·∫¢nh g·ªëc (tr√°nh r√≤ r·ªâ b·∫£o m·∫≠t)\n‚Ä¢ K·∫æT QU·∫¢: Kh√¥i ph·ª•c ho√†n h·∫£o 100%!', ...
                                              'Units', 'normalized', ...
                                              'Position', [0.02 0.02 0.46 0.66], ...
                                              'HorizontalAlignment', 'left', ...
                                              'BackgroundColor', [0.95 1 0.95], ...
                                              'FontSize', 9);
    end

%% CALLBACK FUNCTIONS

    function embed_loadOriginalImage(~, ~)
        handles = get(gcf, 'UserData');
        try
            [filename, pathname] = uigetfile({'*.jpg;*.jpeg;*.png;*.bmp;*.tif', 'Image Files'}, ...
                'Ch·ªçn ·∫£nh g·ªëc');
            
            if filename ~= 0
                filepath = fullfile(pathname, filename);
                handles.embed_data.original_image = imread(filepath);
                
                axes(handles.embed_axes_original);
                imshow(handles.embed_data.original_image);
                title('·∫¢nh g·ªëc');
                updateMatrixTable(handles.embed_matrix_original_table, handles.embed_data.original_image, [1 1]);
                updateMatrixTable(handles.embed_matrix_watermarked_table, [], []);
                updateChangeText(handles, '-');
                
                set(handles.embed_info_text, 'String', sprintf('ƒê√£ n·∫°p ·∫£nh: %s\nK√≠ch th∆∞·ªõc: %dx%d', ...
                    filename, size(handles.embed_data.original_image, 2), size(handles.embed_data.original_image, 1)));
            end
        catch err
            set(handles.embed_info_text, 'String', sprintf('L·ªói n·∫°p ·∫£nh: %s', err.message));
        end
        set(gcf, 'UserData', handles);
    end

    function embed_loadDemoImage(~, ~)
        handles = get(gcf, 'UserData');
        try
            demo_image = create_demo_image();
            handles.embed_data.original_image = demo_image;
            
            axes(handles.embed_axes_original);
            imshow(handles.embed_data.original_image);
            title('·∫¢nh demo');
            updateMatrixTable(handles.embed_matrix_original_table, handles.embed_data.original_image, [1 1]);
            updateMatrixTable(handles.embed_matrix_watermarked_table, [], []);
            updateChangeText(handles, '-');
            
            set(handles.embed_info_text, 'String', 'ƒê√£ n·∫°p ·∫£nh demo th√†nh c√¥ng!');
        catch err
            set(handles.embed_info_text, 'String', sprintf('L·ªói t·∫°o ·∫£nh demo: %s', err.message));
        end
        set(gcf, 'UserData', handles);
    end

    function embed_performEmbedding(~, ~)
        handles = get(gcf, 'UserData');
        
        if ~isfield(handles.embed_data, 'original_image') || isempty(handles.embed_data.original_image)
            set(handles.embed_info_text, 'String', 'Vui l√≤ng n·∫°p ·∫£nh g·ªëc tr∆∞·ªõc!');
            return;
        end
        
        secret_text = get(handles.embed_secret_edit, 'String');
        if isempty(secret_text)
            set(handles.embed_info_text, 'String', 'Vui l√≤ng nh·∫≠p d·ªØ li·ªáu b√≠ m·∫≠t!');
            return;
        end
        
        try
            set(handles.embed_info_text, 'String', 'ƒêang th·ª±c hi·ªán gi·∫•u tin...');
            drawnow;
            
            % Convert text to binary
            secret_bits = text_to_binary(secret_text);
            secret_bit_length = length(secret_bits);
            
            % Choose algorithm
            algorithm_idx = get(handles.embed_algorithm_popup, 'Value');
            if algorithm_idx == 1 % HS
                [handles.embed_data.watermarked_image, handles.embed_data.embed_info] = ...
                    embed_HS(handles.embed_data.original_image, secret_bits);
                algorithm_name = 'Histogram Shifting';
            else % DE
                [handles.embed_data.watermarked_image, handles.embed_data.embed_info] = ...
                    embed_DE(handles.embed_data.original_image, secret_bits);
                algorithm_name = 'Difference Expansion';
            end
            
            % Display watermarked image
            axes(handles.embed_axes_watermarked);
            imshow(handles.embed_data.watermarked_image);
            title('·∫¢nh ƒë√£ gi·∫•u tin');
            updateMatrixTable(handles.embed_matrix_watermarked_table, handles.embed_data.watermarked_image);
            updateMatrixTable(handles.embed_matrix_original_table, handles.embed_data.original_image);
            
            % Calculate PSNR
            psnr_value = calculate_psnr(handles.embed_data.original_image, handles.embed_data.watermarked_image);
            
            % Store additional info
            handles.embed_data.secret_text = secret_text;
            handles.embed_data.algorithm = algorithm_name;
            handles.embed_data.psnr = psnr_value;
            
            % T√≠nh s·ªë pixel thay ƒë·ªïi d·ª±a tr√™n v·ªã tr√≠ embed (ch√≠nh x√°c v·ªõi HS/DE)
            if isfield(handles.embed_data, 'embed_info') && isfield(handles.embed_data.embed_info, 'embedded_locations')
                changed_pixels = size(handles.embed_data.embed_info.embedded_locations, 1);
                if changed_pixels > 0
                    focus_rc = handles.embed_data.embed_info.embedded_locations(1, 1:2);
                else
                    focus_rc = [1, 1];
                end
            elseif isfield(handles.embed_data, 'embed_info') && isfield(handles.embed_data.embed_info, 'locations')
                changed_pixels = size(handles.embed_data.embed_info.locations, 1) * 2; % m·ªói c·∫∑p 2 pixel thay ƒë·ªïi
                if changed_pixels > 0
                    focus_rc = handles.embed_data.embed_info.locations(1, 1:2);
                else
                    focus_rc = [1, 1];
                end
            else
                % Fallback t√≠nh tr·ª±c ti·∫øp t·ª´ ·∫£nh
                orig_gray = getLumaChannel(handles.embed_data.original_image);
                wm_gray = getLumaChannel(handles.embed_data.watermarked_image);
                changed_mask = orig_gray ~= wm_gray;
                changed_pixels = nnz(changed_mask);
                if changed_pixels > 0
                    [first_r, first_c] = find(changed_mask, 1, 'first');
                    focus_rc = [first_r, first_c];
                else
                    focus_rc = [1, 1];
                end
            end

            updateMatrixTable(handles.embed_matrix_watermarked_table, handles.embed_data.watermarked_image, focus_rc);
            updateMatrixTable(handles.embed_matrix_original_table, handles.embed_data.original_image, focus_rc);
            updateChangeText(handles, num2str(changed_pixels));

            set(handles.embed_info_text, 'String', sprintf('Gi·∫•u tin th√†nh c√¥ng!\nThu·∫≠t to√°n: %s\nD·ªØ li·ªáu: %d bit\nPSNR: %.2f dB\nPixel thay ƒë·ªïi: %d\nB·∫°n c√≥ th·ªÉ l∆∞u ·∫£nh v√† th√¥ng tin embed.', ...
                algorithm_name, secret_bit_length, psnr_value, changed_pixels));

        catch err
            set(handles.embed_info_text, 'String', sprintf('L·ªói gi·∫•u tin: %s', err.message));
        end
        
        set(gcf, 'UserData', handles);
    end

    function embed_saveWatermarkedImage(~, ~)
        handles = get(gcf, 'UserData');
        
        if ~isfield(handles.embed_data, 'watermarked_image') || isempty(handles.embed_data.watermarked_image)
            if isfield(handles, 'embed_info_text')
                set(handles.embed_info_text, 'String', 'Ch∆∞a c√≥ ·∫£nh ƒë√£ gi·∫•u tin ƒë·ªÉ l∆∞u!');
            else
                fprintf('Ch∆∞a c√≥ ·∫£nh ƒë√£ gi·∫•u tin ƒë·ªÉ l∆∞u!\n');
            end
            return;
        end
        
        [filename, pathname] = uiputfile({'*.png', 'PNG Files (*.png)'; '*.jpg', 'JPEG Files (*.jpg)'}, ...
            'L∆∞u ·∫£nh ƒë√£ gi·∫•u tin');
        
        if filename ~= 0
            filepath = fullfile(pathname, filename);
            imwrite(handles.embed_data.watermarked_image, filepath);
            if isfield(handles, 'embed_info_text')
                set(handles.embed_info_text, 'String', sprintf('ƒê√£ l∆∞u ·∫£nh: %s', filename));
            else
                fprintf('ƒê√£ l∆∞u ·∫£nh: %s\n', filename);
            end
        end
    end

    function embed_saveEmbedInfo(~, ~)
        handles = get(gcf, 'UserData');
        
        if ~isfield(handles.embed_data, 'embed_info') || isempty(handles.embed_data.embed_info)
            if isfield(handles, 'embed_info_text')
                set(handles.embed_info_text, 'String', 'Ch∆∞a c√≥ th√¥ng tin embed ƒë·ªÉ l∆∞u!');
            else
                fprintf('Ch∆∞a c√≥ th√¥ng tin embed ƒë·ªÉ l∆∞u!\n');
            end
            return;
        end
        
        [filename, pathname] = uiputfile({'*.mat', 'MATLAB Files (*.mat)'}, ...
            'L∆∞u th√¥ng tin embed');
        
        if filename ~= 0
            filepath = fullfile(pathname, filename);
            embed_info = handles.embed_data.embed_info;
            save(filepath, 'embed_info');
            if isfield(handles, 'embed_info_text')
                set(handles.embed_info_text, 'String', sprintf('ƒê√£ l∆∞u th√¥ng tin embed: %s', filename));
            else
                fprintf('ƒê√£ l∆∞u th√¥ng tin embed: %s\n', filename);
            end
        end
    end

%% TAB 2 CALLBACKS (EXTRACTION)

    function extract_loadWatermarkedImage(~, ~)
        handles = get(gcf, 'UserData');
        try
            [filename, pathname] = uigetfile({'*.jpg;*.jpeg;*.png;*.bmp;*.tif', 'Image Files'}, ...
                'Ch·ªçn ·∫£nh ƒë√£ gi·∫•u tin (KH√îNG ph·∫£i ·∫£nh g·ªëc!)');
            
            if filename ~= 0
                filepath = fullfile(pathname, filename);
                img = imread(filepath);
                
                % KI·ªÇM TRA: C·∫£nh b√°o n·∫øu c√≥ th·ªÉ l√† ·∫£nh g·ªëc
                [~, name, ~] = fileparts(filename);
                is_suspicious = false;
                
                % Ki·ªÉm tra t√™n file c√≥ d·∫•u hi·ªáu l√† ·∫£nh g·ªëc
                suspicious_keywords = {'original', 'goc', 'demo', 'input', 'source'};
                for i = 1:length(suspicious_keywords)
                    if contains(lower(name), suspicious_keywords{i})
                        is_suspicious = true;
                        break;
                    end
                end
                
                if is_suspicious
                    choice = questdlg(sprintf('‚ö†Ô∏è C·∫¢NH B√ÅO:\nFile "%s" c√≥ v·∫ª nh∆∞ l√† ·∫£nh g·ªëc!\n\nB·∫°n c√≥ ch·∫Øc ƒë√¢y l√† ·∫£nh ƒê√É GI·∫§U TIN?', filename), ...
                        'X√°c nh·∫≠n ·∫£nh', 'ƒê√¢y l√† ·∫£nh ƒë√£ gi·∫•u tin', 'H·ªßy v√† ch·ªçn l·∫°i', 'H·ªßy v√† ch·ªçn l·∫°i');
                    if strcmp(choice, 'H·ªßy v√† ch·ªçn l·∫°i')
                        if isfield(handles, 'extract_info_text')
                            set(handles.extract_info_text, 'String', '‚ùå ƒê√£ h·ªßy. Vui l√≤ng ch·ªçn ·∫£nh ƒê√É GI·∫§U TIN!');
                        else
                            fprintf('‚ùå ƒê√£ h·ªßy. Vui l√≤ng ch·ªçn ·∫£nh ƒê√É GI·∫§U TIN!\n');
                        end
                        return;
                    end
                end
                
                handles.extract_data.watermarked_image = img;
                
                axes(handles.extract_axes_watermarked);
                imshow(handles.extract_data.watermarked_image);
                title('·∫¢nh ƒë√£ gi·∫•u tin');
                
                if isfield(handles, 'extract_info_text')
                    set(handles.extract_info_text, 'String', sprintf('‚úÖ ƒê√£ n·∫°p ·∫£nh ƒë√£ gi·∫•u tin: %s\nK√≠ch th∆∞·ªõc: %dx%d\n\nüí° H√£y n·∫°p file th√¥ng tin embed t∆∞∆°ng ·ª©ng!', ...
                        filename, size(handles.extract_data.watermarked_image, 2), size(handles.extract_data.watermarked_image, 1)));
                else
                    fprintf('‚úÖ ƒê√£ n·∫°p ·∫£nh ƒë√£ gi·∫•u tin: %s\n', filename);
                end
            end
        catch err
            if isfield(handles, 'extract_info_text')
                set(handles.extract_info_text, 'String', sprintf('L·ªói n·∫°p ·∫£nh: %s', err.message));
            else
                fprintf('L·ªói n·∫°p ·∫£nh: %s\n', err.message);
            end
        end
        set(gcf, 'UserData', handles);
    end

    function extract_loadEmbedInfo(~, ~)
        handles = get(gcf, 'UserData');
        try
            [filename, pathname] = uigetfile({'*.mat', 'MATLAB Files (*.mat)'}, ...
                'Ch·ªçn file th√¥ng tin embed');
            
            if filename ~= 0
                filepath = fullfile(pathname, filename);
                loaded_data = load(filepath);
                if isfield(loaded_data, 'embed_info')
                    handles.extract_data.embed_info = loaded_data.embed_info;
                    set(handles.extract_info_text, 'String', sprintf('ƒê√£ n·∫°p th√¥ng tin embed: %s\nS·∫µn s√†ng tr√≠ch xu·∫•t!', filename));
                else
                    set(handles.extract_info_text, 'String', 'File kh√¥ng ch·ª©a th√¥ng tin embed h·ª£p l·ªá!');
                end
            end
        catch err
            set(handles.extract_info_text, 'String', sprintf('L·ªói n·∫°p file: %s', err.message));
        end
        set(gcf, 'UserData', handles);
    end

    function extract_performExtraction(~, ~)
        handles = get(gcf, 'UserData');
        
        if ~isfield(handles.extract_data, 'watermarked_image') || isempty(handles.extract_data.watermarked_image)
            set(handles.extract_info_text, 'String', 'Vui l√≤ng n·∫°p ·∫£nh ƒë√£ gi·∫•u tin tr∆∞·ªõc!');
            return;
        end
        
        if ~isfield(handles.extract_data, 'embed_info') || isempty(handles.extract_data.embed_info)
            set(handles.extract_info_text, 'String', 'Vui l√≤ng n·∫°p file th√¥ng tin embed tr∆∞·ªõc!');
            return;
        end
        
        try
            set(handles.extract_info_text, 'String', 'ƒêang tr√≠ch xu·∫•t d·ªØ li·ªáu...');
            drawnow;
            
            % Detect algorithm from embed_info
            if isfield(handles.extract_data.embed_info, 'peak_point')
                % HS algorithm
                [recovered_img, extracted_bits] = extract_HS(handles.extract_data.watermarked_image, handles.extract_data.embed_info);
                algorithm_name = 'Histogram Shifting';
            else
                % DE algorithm
                [recovered_img, extracted_bits] = extract_DE(handles.extract_data.watermarked_image, handles.extract_data.embed_info);
                algorithm_name = 'Difference Expansion';
            end
            
            % Convert bits to text
            extracted_text = binary_to_text(extracted_bits);
            
            % Store results
            handles.extract_data.extracted_text = extracted_text;
            handles.extract_data.recovered_image = recovered_img;
            
            % Display results
            set(handles.extract_result_text, 'String', extracted_text);
            set(handles.extract_info_text, 'String', sprintf('Tr√≠ch xu·∫•t th√†nh c√¥ng!\nThu·∫≠t to√°n: %s\nƒê·ªô d√†i text: %d k√Ω t·ª±', ...
                algorithm_name, length(extracted_text)));
            
        catch err
            set(handles.extract_info_text, 'String', sprintf('L·ªói tr√≠ch xu·∫•t: %s', err.message));
        end
        
        set(gcf, 'UserData', handles);
    end

    function extract_saveData(~, ~)
        handles = get(gcf, 'UserData');
        
        if ~isfield(handles.extract_data, 'extracted_text') || isempty(handles.extract_data.extracted_text)
            set(handles.extract_info_text, 'String', 'Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u!');
            return;
        end
        
        [filename, pathname] = uiputfile({'*.txt', 'Text Files (*.txt)'}, ...
            'L∆∞u d·ªØ li·ªáu tr√≠ch xu·∫•t');
        
        if filename ~= 0
            filepath = fullfile(pathname, filename);
            fid = fopen(filepath, 'w', 'n', 'UTF-8');
            if fid ~= -1
                fprintf(fid, '%s', handles.extract_data.extracted_text);
                fclose(fid);
                set(handles.extract_info_text, 'String', sprintf('ƒê√£ l∆∞u d·ªØ li·ªáu: %s', filename));
            else
                set(handles.extract_info_text, 'String', 'L·ªói ghi file!');
            end
        end
    end

%% TAB 3 CALLBACKS (RECOVERY)

    function recovery_loadWatermarkedImage(~, ~)
        handles = get(gcf, 'UserData');
        try
            [filename, pathname] = uigetfile({'*.jpg;*.jpeg;*.png;*.bmp;*.tif', 'Image Files'}, ...
                'Ch·ªçn ·∫£nh ƒë√£ gi·∫•u tin (KH√îNG ph·∫£i ·∫£nh g·ªëc!)');
            
            if filename ~= 0
                filepath = fullfile(pathname, filename);
                img = imread(filepath);
                
                % KI·ªÇM TRA: C·∫£nh b√°o n·∫øu c√≥ th·ªÉ l√† ·∫£nh g·ªëc
                [~, name, ~] = fileparts(filename);
                is_suspicious = false;
                
                % Ki·ªÉm tra t√™n file c√≥ d·∫•u hi·ªáu l√† ·∫£nh g·ªëc
                suspicious_keywords = {'original', 'goc', 'demo', 'input', 'source'};
                for i = 1:length(suspicious_keywords)
                    if contains(lower(name), suspicious_keywords{i})
                        is_suspicious = true;
                        break;
                    end
                end
                
                if is_suspicious
                    choice = questdlg(sprintf('‚ö†Ô∏è C·∫¢NH B√ÅO:\nFile "%s" c√≥ v·∫ª nh∆∞ l√† ·∫£nh g·ªëc!\n\nB·∫°n c√≥ ch·∫Øc ƒë√¢y l√† ·∫£nh ƒê√É GI·∫§U TIN?', filename), ...
                        'X√°c nh·∫≠n ·∫£nh', 'ƒê√¢y l√† ·∫£nh ƒë√£ gi·∫•u tin', 'H·ªßy v√† ch·ªçn l·∫°i', 'H·ªßy v√† ch·ªçn l·∫°i');
                    if strcmp(choice, 'H·ªßy v√† ch·ªçn l·∫°i')
                        if isfield(handles, 'recovery_info_text')
                            set(handles.recovery_info_text, 'String', '‚ùå ƒê√£ h·ªßy. Vui l√≤ng ch·ªçn ·∫£nh ƒê√É GI·∫§U TIN!');
                        else
                            fprintf('‚ùå ƒê√£ h·ªßy. Vui l√≤ng ch·ªçn ·∫£nh ƒê√É GI·∫§U TIN!\n');
                        end
                        return;
                    end
                end
                
                handles.recovery_data.watermarked_image = img;
                
                axes(handles.recovery_axes_watermarked);
                imshow(handles.recovery_data.watermarked_image);
                title('·∫¢nh ƒë√£ gi·∫•u tin');
                
                if isfield(handles, 'recovery_info_text')
                    set(handles.recovery_info_text, 'String', sprintf('‚úÖ ƒê√£ n·∫°p ·∫£nh ƒë√£ gi·∫•u tin: %s\nK√≠ch th∆∞·ªõc: %dx%d\n\nüí° H√£y n·∫°p file th√¥ng tin embed t∆∞∆°ng ·ª©ng!', ...
                        filename, size(handles.recovery_data.watermarked_image, 2), size(handles.recovery_data.watermarked_image, 1)));
                else
                    fprintf('‚úÖ ƒê√£ n·∫°p ·∫£nh ƒë√£ gi·∫•u tin: %s\n', filename);
                end
            end
        catch err
            if isfield(handles, 'recovery_info_text')
                set(handles.recovery_info_text, 'String', sprintf('L·ªói n·∫°p ·∫£nh: %s', err.message));
            else
                fprintf('L·ªói n·∫°p ·∫£nh: %s\n', err.message);
            end
        end
        set(gcf, 'UserData', handles);
    end

    function recovery_loadEmbedInfo(~, ~)
        handles = get(gcf, 'UserData');
        try
            [filename, pathname] = uigetfile({'*.mat', 'MATLAB Files (*.mat)'}, ...
                'Ch·ªçn file th√¥ng tin embed');
            
            if filename ~= 0
                filepath = fullfile(pathname, filename);
                loaded_data = load(filepath);
                if isfield(loaded_data, 'embed_info')
                    handles.recovery_data.embed_info = loaded_data.embed_info;
                    set(handles.recovery_info_text, 'String', sprintf('ƒê√£ n·∫°p th√¥ng tin embed: %s\nS·∫µn s√†ng kh√¥i ph·ª•c!', filename));
                else
                    set(handles.recovery_info_text, 'String', 'File kh√¥ng ch·ª©a th√¥ng tin embed h·ª£p l·ªá!');
                end
            end
        catch err
            set(handles.recovery_info_text, 'String', sprintf('L·ªói n·∫°p file: %s', err.message));
        end
        set(gcf, 'UserData', handles);
    end

    function recovery_performRecovery(~, ~)
        handles = get(gcf, 'UserData');
        
        if ~isfield(handles.recovery_data, 'watermarked_image') || isempty(handles.recovery_data.watermarked_image)
            set(handles.recovery_info_text, 'String', 'Vui l√≤ng n·∫°p ·∫£nh ƒë√£ gi·∫•u tin tr∆∞·ªõc!');
            return;
        end
        
        if ~isfield(handles.recovery_data, 'embed_info') || isempty(handles.recovery_data.embed_info)
            set(handles.recovery_info_text, 'String', 'Vui l√≤ng n·∫°p file th√¥ng tin embed tr∆∞·ªõc!');
            return;
        end
        
        try
            set(handles.recovery_info_text, 'String', 'ƒêang kh√¥i ph·ª•c ·∫£nh g·ªëc...');
            drawnow;
            
            % Detect algorithm and recover
            if isfield(handles.recovery_data.embed_info, 'peak_point')
                % HS algorithm
                [recovered_img, ~] = extract_HS(handles.recovery_data.watermarked_image, handles.recovery_data.embed_info);
                algorithm_name = 'Histogram Shifting';
            else
                % DE algorithm
                [recovered_img, ~] = extract_DE(handles.recovery_data.watermarked_image, handles.recovery_data.embed_info);
                algorithm_name = 'Difference Expansion';
            end
            
            % Store result
            handles.recovery_data.recovered_image = recovered_img;
            
            % Display recovered image
            axes(handles.recovery_axes_recovered);
            imshow(recovered_img);
            title('·∫¢nh ƒë√£ kh√¥i ph·ª•c');
            
            % Calculate comparison metrics
            if isequal(size(handles.recovery_data.watermarked_image), size(recovered_img))
                mse = mean((double(handles.recovery_data.watermarked_image(:)) - double(recovered_img(:))).^2);
                if mse == 0
                    comparison_result = 'HO√ÄN H·∫¢O: ·∫¢nh ƒë∆∞·ª£c kh√¥i ph·ª•c 100%';
                else
                    psnr_recovery = 10 * log10(255^2 / mse);
                    comparison_result = sprintf('MSE: %.6f\nPSNR: %.2f dB', mse, psnr_recovery);
                end
            else
                comparison_result = 'K√≠ch th∆∞·ªõc ·∫£nh kh√°c nhau';
            end
            
            set(handles.recovery_comparison_text, 'String', comparison_result);
            set(handles.recovery_info_text, 'String', sprintf('Kh√¥i ph·ª•c th√†nh c√¥ng!\nThu·∫≠t to√°n: %s\nC√≥ th·ªÉ l∆∞u ·∫£nh ƒë√£ kh√¥i ph·ª•c.', algorithm_name));
            
        catch err
            set(handles.recovery_info_text, 'String', sprintf('L·ªói kh√¥i ph·ª•c: %s', err.message));
        end
        
        set(gcf, 'UserData', handles);
    end

    function recovery_saveRecoveredImage(~, ~)
        handles = get(gcf, 'UserData');
        
        if ~isfield(handles.recovery_data, 'recovered_image') || isempty(handles.recovery_data.recovered_image)
            set(handles.recovery_info_text, 'String', 'Ch∆∞a c√≥ ·∫£nh ƒë√£ kh√¥i ph·ª•c ƒë·ªÉ l∆∞u!');
            return;
        end
        
        [filename, pathname] = uiputfile({'*.png', 'PNG Files (*.png)'; '*.jpg', 'JPEG Files (*.jpg)'}, ...
            'L∆∞u ·∫£nh ƒë√£ kh√¥i ph·ª•c');
        
        if filename ~= 0
            filepath = fullfile(pathname, filename);
            imwrite(handles.recovery_data.recovered_image, filepath);
            set(handles.recovery_info_text, 'String', sprintf('ƒê√£ l∆∞u ·∫£nh ƒë√£ kh√¥i ph·ª•c: %s', filename));
        end
    end

    function closeGUI(~, ~)
        delete(gcf);
    end

end
